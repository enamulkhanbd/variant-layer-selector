<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Variant Layer Selector</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 0;
      padding: 0;
      font-size: 12px;
      color: #0f172a;
      background: #f8fafc;
      line-height: 1.5;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      user-select: none;
      -webkit-user-select: none;
    }

    /* --- TOPBAR --- */
    #topbar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
      color: #f1f5f9;
      border-bottom: 1px solid #0b1220;
      flex-shrink: 0;
      z-index: 10;
    }
    
    #topbar-title {
      font-size: 11px;
      letter-spacing: 0.02em;
      opacity: 0.95;
    }
    
    #back-btn {
      appearance: none;
      border: none;
      background: rgba(241, 245, 249, 0.1);
      color: #f1f5f9;
      border-radius: 6px;
      padding: 5px 10px;
      font-size: 11px;
      cursor: pointer;
      display: none;
      transition: background 0.15s ease;
    }
    
    #back-btn:hover {
      background: rgba(241, 245, 249, 0.15);
    }

    /* --- MAIN CONTAINER --- */
    #container {
      padding: 16px;
      flex-grow: 1;
      min-height: 0;
      overflow-y: auto;
      overflow-x: hidden;
      display: grid;
      gap: 12px;
      align-content: start;
    }

    /* Custom scrollbar */
    #container::-webkit-scrollbar {
      width: 8px;
    }
    
    #container::-webkit-scrollbar-track {
      background: transparent;
    }
    
    #container::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }
    
    #container::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    .info-text {
      color: #64748b;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      background: #ffffff;
      font-size: 11px;
    }

    /* --- CARD COMPONENTS --- */
    .card {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      background: #ffffff;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
      overflow: hidden;
    }
    
    .card-header {
      padding: 12px 14px;
      border-bottom: 1px solid #e2e8f0;
      background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
    }
    
    .card-title {
      margin: 0;
      font-size: 12px;
      color: #0f172a;
      letter-spacing: 0.01em;
    }
    
    .card-content {
      padding: 12px 14px;
      display: grid;
      gap: 12px;
    }

    /* --- HOME LIST --- */
    .home-list {
      display: grid;
      gap: 10px;
    }
    
    .home-item {
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .home-item:hover {
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
      border-color: #cbd5e1;
    }
    
    .home-item:active {
      transform: translateY(1px);
    }
    
    .home-item-title {
      font-size: 12px;
      color: #0f172a;
    }
    
    .home-item .chevron {
      width: 16px;
      height: 16px;
      color: #94a3b8;
    }

    /* --- OPTION GROUP --- */
    .option-group {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      background: #f8fafc;
      overflow: hidden;
      transition: all 0.15s ease;
    }
    
    .option-group:hover {
      border-color: #c7d2fe;
      box-shadow: 0 1px 3px rgba(99, 102, 241, 0.12);
    }
    
    .option-title {
      padding: 10px 12px;
      background: rgba(99, 102, 241, 0.08);
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
      transition: background 0.15s ease;
    }
    
    .option-title:hover {
      background: rgba(99, 102, 241, 0.12);
    }
    
    .option-title label {
      color: #312e81;
      font-size: 11px;
      letter-spacing: 0.01em;
      cursor: pointer;
      flex: 1;
    }

    .option-group > .layers-list {
      padding: 8px 10px 10px 14px;
    }

    .option-group > .layers-list.layers-list--root {
      padding-left: 10px;
    }

    /* Checkbox styling */
    input[type="checkbox"] {
      width: 14px;
      height: 14px;
      accent-color: #6366f1;
      cursor: pointer;
      margin: 0;
      flex-shrink: 0;
    }

    /* --- LAYER TREE --- */
    .layers-list {
      margin: 0;
      padding: 4px 0 4px 16px;
      display: grid;
      gap: 2px;
    }

    .layers-list.layers-list--root {
      padding-left: 0;
    }

    .layer-item {
      margin: 0;
      padding: 0;
    }

    .layer-item--collapsed > .layers-list {
      display: none;
    }

    .layer-item-header {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 5px 8px;
      cursor: pointer;
      user-select: none;
      border-radius: 6px;
      transition: all 0.15s ease;
    }

    .layer-item-header:hover {
      background: #eef2ff;
    }

    .layer-toggle,
    .layer-toggle-placeholder {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
    }

    .layer-toggle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      border: none;
      background: none;
      color: #6366f1;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.15s ease;
    }

    .layer-toggle:hover {
      background: rgba(99, 102, 241, 0.12);
    }

    .layer-toggle svg {
      width: 12px;
      height: 12px;
      transition: transform 0.15s ease;
    }

    .layer-item--parent:not(.layer-item--collapsed) > .layer-item-header .layer-toggle svg {
      transform: rotate(90deg);
    }

    .layer-toggle-placeholder {
      display: inline-block;
    }

    .layer-item label {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex-grow: 1;
      line-height: 14px;
      font-size: 11px;
      color: #1e293b;
      cursor: pointer;
    }

    /* --- FOOTER --- */
    #footer {
      position: sticky;
      bottom: 0;
      padding: 14px 16px;
      background: rgba(248, 250, 252, 0.9);
      border-top: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      backdrop-filter: blur(8px);
      flex-shrink: 0;
    }

    #selection-count {
      font-size: 11px;
      color: #64748b;
      white-space: nowrap;
    }

    button#select-button {
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
      color: white;
      border: none;
      padding: 7px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-family: inherit;
      font-size: 11px;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25);
      transition: all 0.15s ease;
    }

    button#select-button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(99, 102, 241, 0.3);
    }

    button#select-button:disabled {
      background: #e2e8f0;
      color: #94a3b8;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    /* Resizer handles removed for smooth scrolling */

    /* SVG Icons */
    .chevron {
      display: inline-block;
      vertical-align: middle;
    }
  </style>
</head>
<body>

  <div id="topbar">
    <button id="back-btn">‚Üê Back</button>
    <span id="topbar-title">Variant Layer Selector</span>
  </div>

  <div id="container">
    <p class="info-text">Please select a component, variant, or instance on the canvas.</p>
  </div>

  <div id="footer">
    <span id="selection-count">No layer selected</span>
    <button id="select-button" disabled>Select Layers</button>
  </div>

  

  <script>
    const container = document.getElementById('container');
    const topbarTitle = document.getElementById('topbar-title');
    const backBtn = document.getElementById('back-btn');

    const appState = {
      page: 'home',
      groups: [],
      currentProperty: null,
      titleBase: 'Selection',
    };

    // Chevron SVG icon
    const chevronSVG = `<svg class="chevron" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>`;

    function updateGlobalCount() {
      const count = document.querySelectorAll('.layer-checkbox:checked').length;
      const countEl = document.getElementById('selection-count');
      const button = document.getElementById('select-button');
      
      if (!countEl || !button) return;
      
      if (count === 0) {
        countEl.textContent = 'No layer selected';
        button.textContent = 'Select Layers';
      } else if (count === 1) {
        countEl.textContent = '1 layer selected';
        button.textContent = 'Select Layer';
      } else {
        countEl.textContent = `${count} layers selected`;
        button.textContent = 'Select Layers';
      }
      
      button.disabled = (count === 0);
    }

    function setPage(page, title) {
      appState.page = page;
      topbarTitle.textContent = title || 'Variant Layer Selector';
      backBtn.style.display = page === 'home' ? 'none' : 'inline-block';
    }

    function renderHome(properties) {
      setPage('home', 'Variant Layer Selector');
      const labels = properties && properties.length
        ? properties
        : [];

      if (labels.length === 0) {
        container.innerHTML = '<p class="info-text">Please select a component, variant, or instance on the canvas.</p>';
        return;
      }

      container.innerHTML = `<div class="home-list">${labels.map(l => `
        <div class="home-item" data-prop="${l}">
          <span class="home-item-title">${l}</span>
          ${chevronSVG}
        </div>
      `).join('')}</div>`;
    }

    function updateParentCheckboxState(childCheckbox) {
      const optionGroup = childCheckbox.closest('.option-group');
      if (!optionGroup) return;

      const parentCheckbox = optionGroup.querySelector('.option-checkbox-all');
      const allLayerCheckboxes = optionGroup.querySelectorAll('.layer-checkbox');
      
      if (!parentCheckbox || allLayerCheckboxes.length === 0) return;

      const total = allLayerCheckboxes.length;
      let checkedCount = 0;
      allLayerCheckboxes.forEach(cb => {
        if (cb.checked) checkedCount++;
      });

      if (checkedCount === 0) {
        parentCheckbox.indeterminate = false;
        parentCheckbox.checked = false;
      } else if (checkedCount === total) {
        parentCheckbox.indeterminate = false;
        parentCheckbox.checked = true;
      } else {
        parentCheckbox.indeterminate = true;
        parentCheckbox.checked = false;
      }
    }

    function buildTree(layers) {
      const map = new Map();
      const tree = [];

      for (const layer of layers) {
        map.set(layer.path, { ...layer, children: [] });
      }

      for (const [path, node] of map.entries()) {
        const parts = path.split('/').filter(p => p !== '');
        
        if (parts.length > 1) {
          parts.pop();
          const parentPath = parts.join('/') + '/';
          const parent = map.get(parentPath);
          
          if (parent) {
            parent.children.push(node);
          } else {
            tree.push(node);
          }
        } else {
          tree.push(node);
        }
      }

      for (const node of map.values()) {
        node.children.sort((a, b) => {
          const nameA = a.name.split('/').pop();
          const nameB = b.name.split('/').pop();
          return nameA.localeCompare(nameB);
        });
      }
      
      tree.sort((a, b) => {
        const nameA = a.name.split('/').pop();
        const nameB = b.name.split('/').pop();
        return nameA.localeCompare(nameB);
      });

      return tree;
    }

    function buildLayerHtml(layers, propertyName, optionValue, depth = 0) {
      if (!layers || layers.length === 0) return '';
      
      let html = `<div class="layers-list${depth === 0 ? ' layers-list--root' : ''}">`;
      
      layers.forEach((layer) => {
        const nodeIdsValue = JSON.stringify(layer.nodeIds);
        const uniqueId = `cb-${propertyName}-${optionValue}-${layer.path.replace(/[^a-zA-Z0-9]/g, '-')}`;
        const displayName = layer.name.split('/').pop();
        const hasChildren = layer.children && layer.children.length > 0;
        const itemClass = ['layer-item', hasChildren ? 'layer-item--parent' : 'layer-item--leaf'].join(' ');
        const toggleMarkup = hasChildren
          ? `<button type="button" class="layer-toggle" aria-expanded="true">
              <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M4 3L7 6L4 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>`
          : `<span class="layer-toggle-placeholder"></span>`;

        html += `
          <div class="${itemClass}">
            <div class="layer-item-header">
              ${toggleMarkup}
              <input type="checkbox" class="layer-checkbox" value='${nodeIdsValue}' id="${uniqueId}">
              <label for="${uniqueId}" title="${layer.name}">${displayName}</label>
            </div>
        `;
        
        if (hasChildren) {
          html += buildLayerHtml(layer.children, propertyName, optionValue, depth + 1);
        }
        
        html += `</div>`;
      });
      
      html += `</div>`;
      return html;
    }

    window.onmessage = event => {
      const msg = event.data.pluginMessage;

      if (msg.type === 'load-node-layers') {
        appState.currentProperty = null;
        container.innerHTML = '';

        const titleBase = (msg.data?.containerName && msg.data.containerName.trim() !== '')
          ? msg.data.containerName.trim()
          : (msg.data?.containerType || 'Selection');
        const layers = msg.data?.layers || [];
        appState.titleBase = titleBase;

        if (layers.length === 0) {
          container.innerHTML = `<p class="info-text">${titleBase} has no layers to display.</p>`;
          updateGlobalCount();
          return;
        }

        const layerTree = buildTree(layers);
        const html = `
          <div class="card">
            <div class="card-header"><h3 class="card-title">Layers in ${titleBase}</h3></div>
            <div class="card-content">
              <div class="option-group">
                <div class="option-title">
                  <input type="checkbox" class="option-checkbox-all">
                  <label>All layers</label>
                </div>
                ${buildLayerHtml(layerTree, 'layers', 'all')}
              </div>
            </div>
          </div>`;

        container.innerHTML = html;
        setPage('single', `Layers in ${titleBase}`);

        updateGlobalCount();
        return;
      }

      if (msg.type === 'load-groups') {
        container.innerHTML = '';
        
        if (msg.data.length === 0) {
           container.innerHTML = `<p class="info-text">No layers found for this selection.</p>`;
           updateGlobalCount();
           return;
        }
        appState.groups = msg.data;
        renderHome(appState.groups.map(g => g.propertyName));
        updateGlobalCount();
      }

      if (msg.type === 'no-selection') {
        container.innerHTML = `<p class="info-text">${msg.message || 'Please select a component, component set, frame, group, or section.'}</p>`;
        updateGlobalCount();
      }
    };

    document.getElementById('select-button').onclick = () => {
      const checkedBoxes = document.querySelectorAll('.layer-checkbox:checked');
      const allIdsToSelect = new Set();
      
      checkedBoxes.forEach(cb => {
        const ids = JSON.parse(cb.value);
        ids.forEach(id => allIdsToSelect.add(id));
      });
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'select-layers', 
          ids: Array.from(allIdsToSelect) 
        } 
      }, '*');
    };

    document.addEventListener('change', event => {
      if (event.target.classList.contains('option-checkbox-all')) {
        const isChecked = event.target.checked;
        event.target.indeterminate = false; 
        
        const optionGroup = event.target.closest('.option-group');
        if (optionGroup) {
          const layerCheckboxes = optionGroup.querySelectorAll('.layer-checkbox');
          layerCheckboxes.forEach(cb => cb.checked = isChecked);
        }
      }
      
      if (event.target.classList.contains('layer-checkbox')) {
        updateParentCheckboxState(event.target);
      }

      if (event.target.type === 'checkbox') {
        updateGlobalCount();
      }
    });

    container.addEventListener('click', event => {
      const homeItem = event.target.closest('.home-item');
      if (homeItem) {
        const prop = homeItem.getAttribute('data-prop');
        const group = appState.groups.find(g => g.propertyName === prop);
        if (!group) return;
        appState.currentProperty = prop;

        let html = `
          <div class="card">
            <div class="card-header"><h3 class="card-title">${group.propertyName}</h3></div>
            <div class="card-content">
        `;
        group.options.forEach(option => {
          html += `
            <div class="option-group">
              <div class="option-title">
                <input type="checkbox" class="option-checkbox-all">
                <label>${option.value}</label>
              </div>
              ${buildLayerHtml(buildTree(option.uniqueLayers), group.propertyName, option.value)}
            </div>
          `;
        });
        html += `</div></div>`;
        container.innerHTML = html;
        setPage('property', group.propertyName);
        updateGlobalCount();
        return;
      }

      const toggleButton = event.target.closest('.layer-toggle');
      if (toggleButton) {
        const layerItem = toggleButton.closest('.layer-item');
        if (!layerItem) return;
        const isCollapsed = layerItem.classList.toggle('layer-item--collapsed');
        toggleButton.setAttribute('aria-expanded', (!isCollapsed).toString());
        event.preventDefault();
        event.stopPropagation();
        return;
      }
      
      const optionTitle = event.target.closest('.option-title');
      if (optionTitle && event.target.type !== 'checkbox') {
        const checkbox = optionTitle.querySelector('.option-checkbox-all');
        if (checkbox) {
          checkbox.checked = !checkbox.checked;
          checkbox.dispatchEvent(new Event('change', { bubbles: true }));
        }
        return;
      }

      const layerHeader = event.target.closest('.layer-item-header');
      if (layerHeader && event.target.type !== 'checkbox') {
        const checkbox = layerHeader.querySelector('.layer-checkbox');
        if (checkbox) {
          checkbox.checked = !checkbox.checked;
          checkbox.dispatchEvent(new Event('change', { bubbles: true }));
        }
        return;
      }
    });

    backBtn.addEventListener('click', () => {
      if (appState.groups && appState.groups.length) {
        renderHome(appState.groups.map(g => g.propertyName));
        updateGlobalCount();
      } else {
        renderHome();
      }
    });

    // Resizer removed; window size is controlled from code.js only
  </script>
</body>
</html>
