figma.ui.onmessage = async (msg) => {
  if (msg.type === 'select-layers') {
    if (!originalSelection) {
      figma.notify('Your selection has changed. Please re-select a component.', { error: true });
      return;
    }

    const includeParents = !!msg.includeParents; // <- new
    const nodesToSelect = new Set();

    for (const id of msg.ids) {
      try {
        const node = await figma.getNodeByIdAsync(id);
        if (node) {
          nodesToSelect.add(node);

          // Only add parents if the UI requested it
          if (includeParents) {
            let parent = node.parent;
            while (parent && parent.type !== 'PAGE') {
              nodesToSelect.add(parent);
              parent = parent.parent;
            }
          }
        }
      } catch (err) {
        // skip invalid nodes
      }
    }

    const uniqueNodes = Array.from(nodesToSelect);
    figma.currentPage.selection = uniqueNodes;
    if (uniqueNodes.length > 0) figma.viewport.scrollAndZoomIntoView(uniqueNodes);

    const suffix = includeParents ? ' (including parents)' : '';
    figma.notify(`Selected ${uniqueNodes.length} layer${uniqueNodes.length > 1 ? 's' : ''}${suffix}.`);
  }
};
